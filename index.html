<!DOCTYPE html>
<html>
<head>
    <title>スタンプカード</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; }
        #qrcode { width: 256px; height: 256px; margin: 20px auto; }
        #stamps { font-size: 3em; font-weight: bold; }
    </style>
</head>
<body>
    <h1>あなたのスタンプカード</h1>
    <div id="qrcode"></div>
    <p>現在のスタンプ数</p>
    <p id="stamps">0</p>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyClDJHiOlr_PHtewVXdiZBFhEd7rUluwac",
            authDomain: "max-stamp-card.firebaseapp.com",
            projectId: "max-stamp-card",
            storageBucket: "max-stamp-card.appspot.com", // こちらを修正しました
            messagingSenderId: "539021057344",
            appId: "1:539021057344:web:c4177e41fa35505680aea5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const messaging = firebase.messaging(); // メッセージング機能を有効化

        // ▼▼▼ プッシュ通知の機能を追加 ▼▼▼
        function requestNotificationPermission(userId) {
            messaging.requestPermission().then(() => {
                console.log('Notification permission granted.');
                // FCMトークンを取得してDBに保存
                return messaging.getToken();
            }).then(token => {
                console.log('FCM Token:', token);
                // ユーザーのデータにFCMトークンを保存
                db.collection("users").doc(userId).update({ fcmToken: token });
            }).catch((err) => {
                console.log('Unable to get permission to notify.', err);
            });
        }
        // ▲▲▲ プッシュ通知の機能を追加 ▲▲▲

        // URLからユーザーIDを取得
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        if (userId) {
            // 自分のIDでQRコードを生成
            new QRCode(document.getElementById("qrcode"), userId);

            // データベースを監視してスタンプ数を表示
            db.collection("users").doc(userId).onSnapshot((doc) => {
                if (doc.exists) {
                    document.getElementById("stamps").innerText = doc.data().stamps || 0;
                } else {
                    // 初めてのユーザーならデータを作成
                    db.collection("users").doc(userId).set({ stamps: 0 });
                }
            });
            
            // 初回アクセス時に通知の許可を求める
            requestNotificationPermission(userId);

        } else {
            document.body.innerHTML = "<h1>無効なURLです</h1>";
        }
    </script>
</body>
</html>