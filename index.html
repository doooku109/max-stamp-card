<!DOCTYPE html>
<html>
<head>
    <title>スタンプカード</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; }
        #qr-container { width: 256px; height: 256px; margin: 20px auto; }
        
        /* ▼▼▼ スタンプのデザイン ▼▼▼ */
        #stamp-sheet {
            display: grid;
            grid-template-columns: repeat(10, 1fr); /* 横に10個並べる */
            gap: 5px;
            width: 90%;
            max-width: 400px;
            margin: 20px auto;
            border: 2px solid #ccc;
            padding: 10px;
            border-radius: 8px;
        }
        .stamp-slot {
            width: 100%;
            padding-bottom: 100%; /* 正方形にするためのテクニック */
            position: relative;
            background-color: #f0f0f0;
            border-radius: 50%; /* 丸いマスにする */
        }
        .stamp-mark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            font-weight: bold;
            color: #d9534f;
            display: none; /* 初期状態では非表示 */
        }
        .filled .stamp-mark {
            display: block; /* .filledクラスが付いたら表示 */
        }
        /* ▲▲▲ ここまで ▲▲▲ */

        #load-stamps-btn { padding: 10px 20px; font-size: 1em; cursor: pointer; margin-top: 10px; }
        #history-container { margin-top: 30px; text-align: left; display: inline-block; }
        /* ... その他のスタイルは変更なし ... */
    </style>
</head>
<body>
    <h1>あなたのスタンプカード</h1>
    
    <div id="stamp-sheet">
        </div>

    <button id="load-stamps-btn">スタンプと履歴を更新</button>
    <hr>
    <div id="qr-container">
        <canvas id="qr"></canvas>
    </div>
    <div id="history-container">
        <h3>最近の来店履歴</h3>
        <ul id="history-list">
            <li>（ボタンを押して確認）</li>
        </ul>
    </div>

    <script>
        // --- Phase 1: QRコードとスタンプの枠を描画 ---
        document.addEventListener('DOMContentLoaded', function() {
            // ▼▼▼ スタンプの枠を50個生成する ▼▼▼
            const stampSheet = document.getElementById('stamp-sheet');
            for (let i = 0; i < 50; i++) {
                const slot = document.createElement('div');
                slot.classList.add('stamp-slot');
                slot.innerHTML = '<span class="stamp-mark">Ⓜ</span>';
                stampSheet.appendChild(slot);
            }
            // ▲▲▲ ここまで ▲▲▲

            // ... QRコード表示とボタンの処理は変更なし ...
        });

        // --- Phase 2: データベース接続部分を修正 ---
        function initializeFirebaseAndRender(userId) {
            // ... Firebase初期化は変更なし ...
            
            db.collection("users").doc(userId).onSnapshot((doc) => {
                // ▼▼▼ スタンプの数を取得して、マークを表示する処理 ▼▼▼
                const stampSlots = document.querySelectorAll('.stamp-slot');
                let stampCount = 0;
                if (doc.exists) {
                    stampCount = doc.data().stamps || 0;
                }
                
                stampSlots.forEach((slot, index) => {
                    if (index < stampCount) {
                        slot.classList.add('filled'); // スタンプ数に応じて.filledクラスを付与
                    } else {
                        slot.classList.remove('filled');
                    }
                });
                // ▲▲▲ ここまで ▲▲▲

                // ... 履歴表示とボタンの処理は変更なし ...
            });
        }
        // ... その他の関数は変更なし ...
    </script>
</body>
</html>
