<!DOCTYPE html>
<html>
<head>
    <style>
        /* ... style内は変更なし ... */
    </style>
</head>
<body>
    <script>
        // --- Phase 1: ページ読み込み時の処理 (変更なし) ---
        document.addEventListener('DOMContentLoaded', function() {
            // ... この中の処理は変更ありません ...
        });

        // ▼▼▼ Phase 2: スクリプトの読み込み方法をより確実なものに変更 ▼▼▼
        function loadFirebaseAndGetData(userId) {
            const loadButton = document.getElementById('load-stamps-btn');

            // スクリプトを1つずつ順番に読み込む関数
            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error(`スクリプト読込エラー: ${src}`));
                    document.head.appendChild(script);
                });
            }

            // 順番にFirebaseのスクリプトを読み込む
            loadScript("https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js")
                .then(() => {
                    return loadScript("https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js");
                })
                .then(() => {
                    // 全て成功したら、データベースに接続
                    initializeFirebaseAndRender(userId);
                })
                .catch(error => {
                    // もし途中で失敗したら、エラーを表示
                    document.getElementById('valid-term-info').innerText = error.message;
                    loadButton.innerText = 'エラー 발생. 리로드 해주세요.';
                });
        }
        // ▲▲▲ 変更箇所ここまで ▲▲▲

        function initializeFirebaseAndRender(userId) {
            // ... この中の処理は変更ありません ...
        }
    </script>
</body>
</html>
