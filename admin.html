<!DOCTYPE html>
<html>
<head>
    </head>
<body>
    <h1>スタンプ付与スキャナー</h1>
    <p>枠内にQRコードをかざしてください。</p>
    <div id="reader"></div>
    <div id="result"></div>

    <script>
        // ... startApp() と スキャナー起動部分は変更なし ...

        // ▼▼▼ データベース処理を大幅に改造 ▼▼▼
        function runDatabaseTransaction(userId, paymentAmount) {
            // ... Firebase初期化は変更なし ...
            
            db.runTransaction((transaction) => {
                return transaction.get(userRef).then((doc) => {
                    let data = doc.exists ? doc.data() : {};
                    let currentStamps = data.stamps || 0;
                    let currentKeep = data.keep || 0;
                    let history = data.visitHistory || [];
                    let firstStampDate = data.firstStampDate || null; // 有効期限の開始日を取得

                    // --- 特典交換の処理 ---
                    if (paymentAmount === 0) { // 支払額が0円なら特典交換モード
                        if (currentStamps < 50) {
                            throw "スタンプが50個に達していません。";
                        }
                        const today = new Date();
                        const startDate = new Date(firstStampDate);
                        const oneYearLater = new Date(startDate.setFullYear(startDate.getFullYear() + 1));
                        
                        let reward = 500; // デフォルトは500円
                        if (today < oneYearLater) {
                            reward = 1000; // 1年以内なら1000円
                        }
                        
                        // スタンプをリセットし、特典を記録
                        transaction.update(userRef, {
                            stamps: 0,
                            keep: 0,
                            firstStampDate: null, // 有効期限をリセット
                            lastReward: `${today.toISOString().slice(0,10)}に${reward}円特典交換`
                        });
                        return { reward: reward };
                    }

                    // --- 通常のスタンプ付与処理 ---
                    let totalAmount = currentKeep + paymentAmount;
                    totalAmount = Math.round(totalAmount / 10) * 10;
                    const newStamps = Math.floor(totalAmount / 1000);
                    
                    if (newStamps > 0 && currentStamps === 0) {
                        firstStampDate = new Date().toISOString().slice(0, 10); // 最初のスタンプ獲得日を記録
                    }

                    const finalStamps = currentStamps + newStamps;
                    // ... その他の計算は変更なし ...

                    transaction.set(userRef, { 
                        stamps: finalStamps,
                        // ...
                        firstStampDate: firstStampDate // 有効期限の開始日を保存
                    }, { merge: true });

                    return { /* ... */ };
                });
            }).then((result) => {
                if (result.reward) {
                    resultDiv.innerText = `✅ 特典交換完了！\n\n${result.reward}円分の特典を適用してください。`;
                } else {
                    // ... 通常の完了メッセージ ...
                }
            }).catch((error) => { /* ... */ });
        }
    </script>
</body>
</html>
