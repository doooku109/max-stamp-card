<!DOCTYPE html>
<html>
<head>
    <title>お店用スキャナー</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 10px; }
        #reader { max-width: 500px; margin: 20px auto; border: 2px solid #eee; }
        #result { margin-top: 20px; font-weight: bold; color: green; font-size: 1.2em; white-space: pre-wrap; }
        #error { color: red; }
    </style>
</head>
<body>
    <h1>スタンプ付与スキャナー</h1>
    <p>枠内にお客様のQRコードをかざしてください。</p>
    <div id="reader"></div>
    <div id="result"></div>

    <script>
        // アプリケーションを開始するメインの関数
        function startApp() {
            let html5QrcodeScanner; 

            function onScanSuccess(decodedText, decodedResult) {
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.clear();
                }
                const userId = decodedText;
                const resultDiv = document.getElementById('result');
                const amountStr = prompt(`お客様ID: ${userId}\n\nお支払い金額（税抜）を入力してください。`);
                if (amountStr === null || amountStr.trim() === '') {
                    resultDiv.innerText = "キャンセルしました。ページを再読み込みしてください。";
                    return;
                }
                const paymentAmount = parseInt(amountStr, 10);
                if (isNaN(paymentAmount)) {
                    resultDiv.innerHTML = `<p id="error">無効な金額です。ページを再読み込みしてください。</p>`;
                    return;
                }
                resultDiv.innerText = 'データベースに接続中...';
                loadFirebaseAndUpdate(userId, paymentAmount);
            }

            try {
                html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
                html5QrcodeScanner.render(onScanSuccess);
            } catch(e) {
                document.getElementById('result').innerHTML = `<p id="error">カメラの起動に失敗しました。<br>${e.message}</p>`;
            }
        }

        // Firebaseを読み込んでデータベースを更新する関数
        function loadFirebaseAndUpdate(userId, paymentAmount) {
            const scripts = [
                "https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js",
                "https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"
            ];
            let scriptsLoaded = 0;
            scripts.forEach(function(src) {
                const script = document.createElement('script');
                script.src = src;
                script.async = false;
                script.onload = function() {
                    scriptsLoaded++;
                    if (scriptsLoaded === scripts.length) {
                        runDatabaseTransaction(userId, paymentAmount);
                    }
                };
                document.head.appendChild(script);
            });
        }

        // データベース処理を実行する関数
        function runDatabaseTransaction(userId, paymentAmount) {
            const firebaseConfig = {
                apiKey: "AIzaSyClDJHiOlr_PHtewVXdiZBFhEd7rUluwac",
                authDomain: "max-stamp-card.firebaseapp.com",
                projectId: "max-stamp-card",
                storageBucket: "max-stamp-card.appspot.com",
                messagingSenderId: "539021057344",
                appId: "1:539021057344:web:c4177e41fa35505680aea5"
            };
            // 既に初期化されている場合は何もしない
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();
            const userRef = db.collection("users").doc(userId);
            const resultDiv = document.getElementById('result');
            db.runTransaction((transaction) => {
                return transaction.get(userRef).then((doc) => {
                    let data = doc.exists ? doc.data() : {};
                    let currentStamps = data.stamps || 0;
                    let currentKeep = data.keep || 0;
                    let history = data.visitHistory || [];
                    let totalAmount = currentKeep + paymentAmount;
                    totalAmount = Math.round(totalAmount / 10) * 10;
                    const newStamps = Math.floor(totalAmount / 1000);
                    const newKeep = totalAmount % 1000;
                    const finalStamps = currentStamps + newStamps;
                    const today = new Date().toISOString().slice(0, 10);
                    history.push(today);
                    if (history.length > 5) { history.shift(); }
                    transaction.set(userRef, { 
                        stamps: finalStamps, keep: newKeep, lastVisitDate: today, visitHistory: history
                    }, { merge: true });
                    return { addedStamps: newStamps, finalStamps: finalStamps, newKeep: newKeep };
                });
            }).then((result) => {
                resultDiv.innerText = `✅ スタンプを付与しました！\n\n今回追加されたスタンプ: ${result.addedStamps}個\nお客様の合計スタンプ: ${result.finalStamps}個\n次回の繰越金額: ${result.newKeep}円\n\nページを再読み込みして次の人をスキャンしてください。`;
            }).catch((error) => {
                resultDiv.innerHTML = `<p id="error">❌ エラーが発生しました。<br>${error}</p><p>ページを再読み込みしてやり直してください。</p>`;
            });
        }
    </script>

    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js" onload="startApp()"></script>

</body>
</html>
