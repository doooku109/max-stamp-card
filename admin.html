<!DOCTYPE html>
<html>
<head>
    </head>
<body>
    <script>
        // ... document.addEventListenerとloadFirebaseAndUpdate関数は変更なし ...

        function runDatabaseTransaction(userId, paymentAmount) {
            // ... Firebase初期化は変更なし ...

            db.runTransaction((transaction) => {
                return transaction.get(userRef).then((doc) => {
                    // ... 変数定義は変更なし ...

                    if (paymentAmount === 0) { // 特典交換モード
                        // ... エラーチェックと特典金額の計算は変更なし ...
                        
                        // ▼▼▼ 修正箇所：keepをリセットしないように変更 ▼▼▼
                        transaction.update(userRef, { 
                            stamps: 0, // スタンプだけをリセット
                            // keep: 0,  <- この行を削除またはコメントアウト
                            firstStampDate: null, 
                            lastReward: `${new Date().toISOString().slice(0,10)}に${reward}円特典交換` 
                        });
                        return { reward: reward };
                    }

                    // ... 通常のスタンプ付与処理は変更なし ...
                });
            }).then((result) => {
                // ... thenの処理は変更なし ...
            }).catch((error) => {
                // ... catchの処理は変更なし ...
            });
        }
    </script>
</body>
</html>
